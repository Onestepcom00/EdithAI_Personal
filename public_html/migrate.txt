<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Mobile sidebar functionality
    const menuButton = document.getElementById('menuButton');
    const closeSidebar = document.getElementById('closeSidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const sidebar = document.querySelector('.sidebar-mobile');

    function openSidebar() {
        sidebar.classList.add('open');
        mobileOverlay.classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeSidebarFunc() {
        sidebar.classList.remove('open');
        mobileOverlay.classList.remove('open');
        document.body.style.overflow = '';
    }

    if (menuButton) {
        menuButton.addEventListener('click', openSidebar);
    }

    if (closeSidebar) {
        closeSidebar.addEventListener('click', closeSidebarFunc);
    }

    if (mobileOverlay) {
        mobileOverlay.addEventListener('click', closeSidebarFunc);
    }

    // Call button functionality
    function handleCall() {
        showToast('Call feature coming soon!', 'info', 3000);
    }

    const callButton = document.getElementById('callButton');
    const callButtonDesktop = document.getElementById('callButtonDesktop');

    if (callButton) {
        callButton.addEventListener('click', handleCall);
    }

    if (callButtonDesktop) {
        callButtonDesktop.addEventListener('click', handleCall);
    }

    // Model management
    const availableModels = ['EdithAI-P1', 'EdithAI-P2', 'LLama-3.1'];
    let currentModel = localStorage.getItem('selectedModel') || 'GPT-4';
    let toolsSelected = false;
    let uploadedFile = null;

    // DOM elements
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatContainer = document.getElementById('chatContainer');
    const addBtn = document.getElementById('addBtn');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const toolsBtn = document.getElementById('toolsBtn');
    const modelBtn = document.getElementById('modelBtn');
    const toastContainer = document.getElementById('toastContainer');
    let pendingMessage = null;

    // Initialize model button text
    if (modelBtn) {
        modelBtn.innerHTML = `
            <span class="flex items-center space-x-2">
                <span>${currentModel}</span>
                <i data-lucide="chevron-down" class="w-3 h-3"></i>
            </span>
        `;
    }

    /**
     * 
     * Une fonction pour gerer les toast notification 
     * 
     * 
     */
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        const icons = {
            success: 'check-circle',
            error: 'x-circle',
            warning: 'alert-triangle',
            info: 'info'
        };
        
        const colors = {
            success: 'from-green-600 to-green-700 border-green-500/20',
            error: 'from-red-600 to-red-700 border-red-500/20',
            warning: 'from-amber-600 to-amber-700 border-amber-500/20',
            info: 'from-purple-600 to-purple-700 border-purple-500/20'
        };
        
        toast.className = `toast glass rounded-xl p-4 max-w-sm flex items-center space-x-3 bg-gradient-to-r ${colors[type]} shadow-xl`;
        toast.innerHTML = `
            <i data-lucide="${icons[type]}" class="w-5 h-5 text-white flex-shrink-0"></i>
            <p class="text-sm text-white font-medium">${message}</p>
            <button class="ml-auto hover:bg-white/10 rounded-lg p-1 transition-all" onclick="this.parentElement.remove()">
                <i data-lucide="x" class="w-4 h-4 text-white"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        lucide.createIcons();
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }
        }, duration);
    }

    /**
     * 
     * Faire un resize automatique du textarea 
     * 
     * 
     */
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 128) + 'px';
        
        const hasContent = this.value.trim();
        if (hasContent) {
            sendBtn.classList.remove('opacity-0', 'pointer-events-none');
            sendBtn.classList.add('opacity-100');
            sendBtn.disabled = false;
        } else {
            sendBtn.classList.add('opacity-0', 'pointer-events-none');
            sendBtn.classList.remove('opacity-100');
            sendBtn.disabled = true;
        }
    });

    /***
     * 
     * La fonction qui gere l'envoie de messages
     * 
     * 
     */
    function smoothScrollToBottom() {
        setTimeout(() => {
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }

    function addUserMessage(message, file, toolsEnabled) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-4 justify-end';
        
        let fileHtml = '';
        if (file) {
            const extension = file.name.split('.').pop().toLowerCase();
            let iconHtml = '';
            let bgClass = '';
            
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(extension)) {
                iconHtml = '<i data-lucide="image" class="w-4 h-4 text-green-400"></i>';
                bgClass = 'bg-green-600/20 border-green-500/30';
            } else if (['js', 'html', 'css', 'py', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs'].includes(extension)) {
                iconHtml = '<i data-lucide="code" class="w-4 h-4 text-blue-400"></i>';
                bgClass = 'bg-blue-600/20 border-blue-500/30';
            } else {
                iconHtml = '<i data-lucide="file" class="w-4 h-4 text-purple-400"></i>';
                bgClass = 'bg-purple-600/20 border-purple-500/30';
            }
            
            fileHtml = `
                <div class="flex items-center space-x-2 mt-3 p-2 ${bgClass} border rounded-lg">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center ${bgClass}">
                        ${iconHtml}
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-200">${file.name}</p>
                        <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                    </div>
                </div>
            `;
        }
        
        let toolsHtml = '';
        if (toolsEnabled) {
            toolsHtml = `
                <div class="flex items-center space-x-1 mt-2 text-xs text-purple-400">
                    <i data-lucide="wrench" class="w-3 h-3"></i>
                    <span>Tools Selected</span>
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="user-bubble rounded-2xl px-5 py-4 max-w-3xl">
                <p class="text-white text-sm leading-relaxed">${escapeHtml(message)}</p>
                ${fileHtml}
                ${toolsHtml}
            </div>
            <div class="w-8 h-8 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                <span class="text-xs font-semibold text-white"><?=shortName($_TEXT['user']['name']);?></span>
            </div>
        `;
        
        const chatContent = chatContainer.querySelector('.max-w-4xl');
        chatContent.appendChild(messageDiv);
        lucide.createIcons();
        
        // Ajouter un délai pour garantir que le DOM est mis à jour
        setTimeout(smoothScrollToBottom, 150);
    }

    function addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-4';
        messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                <i data-lucide="sparkles" class="w-4 h-4 text-white"></i>
            </div>
            <div class="message-bubble rounded-2xl p-5 max-w-3xl">
                <div class="prose-custom max-w-none">${marked.parse(message)}</div>
            </div>
        `;
        
        const chatContent = chatContainer.querySelector('.max-w-4xl');
        chatContent.appendChild(messageDiv);
        lucide.createIcons();
        
        // Ajouter un délai pour garantir que le DOM est mis à jour
        setTimeout(smoothScrollToBottom, 150);
    }

    // Fonction pour ajuster automatiquement l'espacement sur mobile
    function adjustMobileSpacing() {
        if (window.innerWidth < 768) {
            const chatContent = chatContainer.querySelector('.max-w-4xl');
            if (chatContent) {
                const messages = chatContent.querySelectorAll('.flex.items-start');
                if (messages.length > 0) {
                    // Premier message
                    messages[0].classList.add('first-message-mobile');
                    
                    // Dernier message
                    messages[messages.length - 1].classList.add('last-message-mobile');
                }
            }
        }
    }

    // Appeler cette fonction après chaque ajout de message
    setTimeout(adjustMobileSpacing, 200);

    // Et aussi lors du redimensionnement de la fenêtre
    window.addEventListener('resize', adjustMobileSpacing);

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex items-start space-x-4 typing-indicator';
        typingDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                <i data-lucide="sparkles" class="w-4 h-4 text-white"></i>
            </div>
            <div class="message-bubble rounded-2xl p-5">
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-sm text-gray-400 ml-2">AI is thinking...</span>
                </div>
            </div>
        `;
        
        const chatContent = chatContainer.querySelector('.max-w-4xl');
        chatContent.appendChild(typingDiv);
        lucide.createIcons();
        smoothScrollToBottom();
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function smoothScrollToBottom() {
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    addBtn.addEventListener('click', function() {
        fileInput.click();
    });

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        uploadedFile = file;
        displayFilePreview(file);
    });

    function displayFilePreview(file) {
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileIcon = document.getElementById('fileIcon');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        // Reset previews
        imagePreview.classList.add('hidden');
        fileIcon.innerHTML = '';
        fileIcon.className = 'w-6 h-6 rounded flex items-center justify-center';
        
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(extension)) {
            // Image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            fileIcon.className += ' bg-green-600/20 border border-green-500/30';
            fileIcon.innerHTML = '<i data-lucide="image" class="w-3 h-3 text-green-400"></i>';
        } else if (['js', 'html', 'css', 'py', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs'].includes(extension)) {
            // Code file
            fileIcon.className += ' bg-blue-600/20 border border-blue-500/30';
            fileIcon.innerHTML = '<i data-lucide="code" class="w-3 h-3 text-blue-400"></i>';
        } else if (['txt', 'md', 'rtf'].includes(extension)) {
            // Text file
            fileIcon.className += ' bg-gray-600/20 border border-gray-500/30';
            fileIcon.innerHTML = '<i data-lucide="file-text" class="w-3 h-3 text-gray-400"></i>';
        } else if (['pdf'].includes(extension)) {
            // PDF file
            fileIcon.className += ' bg-red-600/20 border border-red-500/30';
            fileIcon.innerHTML = '<i data-lucide="file-text" class="w-3 h-3 text-red-400"></i>';
        } else if (['docx', 'doc', 'odt'].includes(extension)) {
            // Document file
            fileIcon.className += ' bg-blue-600/20 border border-blue-500/30';
            fileIcon.innerHTML = '<i data-lucide="file-text" class="w-3 h-3 text-blue-400"></i>';
        } else {
            // Generic file
            fileIcon.className += ' bg-purple-600/20 border border-purple-500/30';
            fileIcon.innerHTML = '<i data-lucide="file" class="w-3 h-3 text-purple-400"></i>';
        }
        
        filePreview.classList.remove('hidden');
        lucide.createIcons();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    document.getElementById('removeFile').addEventListener('click', function() {
        uploadedFile = null;
        filePreview.classList.add('hidden');
        fileInput.value = '';
    });

    toolsBtn.addEventListener('click', function() {
        toolsSelected = !toolsSelected;
        
        if (toolsSelected) {
            this.classList.add('bg-purple-600/20', 'border', 'border-purple-500/30');
            this.querySelector('i').classList.remove('text-gray-500');
            this.querySelector('i').classList.add('text-purple-400');
            showToast('Tools enabled for next message', 'info', 2000);
        } else {
            this.classList.remove('bg-purple-600/20', 'border', 'border-purple-500/30');
            this.querySelector('i').classList.add('text-gray-500');
            this.querySelector('i').classList.remove('text-purple-400');
            showToast('Tools disabled', 'info', 2000);
        }
    });

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    /**
     * 
     * Fonction pour le choix d'un model et le sauvegarde directe dans le localStorage
     * 
     * 
     */
    if (modelBtn) {
        modelBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Create enhanced dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'absolute bottom-full mb-2 left-0 glass rounded-xl py-2 min-w-[200px] z-50 shadow-2xl border border-purple-500/20';
            dropdown.innerHTML = availableModels.map(model => {
                const isSelected = model === currentModel;
                const descriptions = {
                    'GPT-4': 'Most capable model',
                    'GPT-3.5-Turbo': 'Fast and efficient',
                    'Claude-3': 'Great for analysis',
                    'Gemini-Pro': 'Multimodal AI',
                    'GPT-4-Turbo': 'Latest GPT-4 version'
                };
                
                return `
                    <button class="w-full text-left px-4 py-3 hover:bg-purple-600/20 transition-all text-sm ${isSelected ? 'bg-purple-600/10' : ''} group" data-model="${model}">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium ${isSelected ? 'text-purple-400' : 'text-gray-200'}">${model}</div>
                                <div class="text-xs text-gray-500">${descriptions[model] || 'AI Model'}</div>
                            </div>
                            ${isSelected ? '<i data-lucide="check" class="w-4 h-4 text-purple-400"></i>' : ''}
                        </div>
                    </button>
                `;
            }).join('');
            
            this.parentElement.style.position = 'relative';
            this.parentElement.appendChild(dropdown);
            lucide.createIcons();
            
            // Handle model selection
            dropdown.addEventListener('click', function(e) {
                if (e.target.closest('[data-model]')) {
                    const selectedModel = e.target.closest('[data-model]').getAttribute('data-model');
                    currentModel = selectedModel;
                    localStorage.setItem('selectedModel', currentModel);
                    
                    modelBtn.innerHTML = `
                        <span class="flex items-center space-x-2">
                            <span>${currentModel}</span>
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </span>
                    `;
                    lucide.createIcons();
                    dropdown.remove();
                    showToast(`Switched to ${selectedModel}`, 'info', 2000);
                }
            });
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown() {
                    if (dropdown.parentElement) {
                        dropdown.remove();
                    }
                    document.removeEventListener('click', closeDropdown);
                });
            }, 0);
        });
    }

    /**
     * 
     * 
     * Fonction pour lancer un nouveau Chat avec l'IA 
     * 
     * 
     */
    async function startNewChat() {
        const apiUrl = BASE_API_URL+"/api/news_chat/?start=true";

        try {
            const response = await fetch(apiUrl, {
                method: "GET"
            });

            if (!response.ok) {
                throw new Error("Erreur HTTP: " + response.status);
            }

            const data = await response.json();
            console.log("Réponse API:", data);

            const chatId = data.id;
            return chatId;
        } catch (error) {
            console.error("Erreur lors de la création du chat :", error);
            return null;
        }
    }

    /**
     * 
     * 
     * Fonction pour envoyer le message en attente après la création du chat
     * 
     * 
     */
    async function sendPendingMessage(chatId) {
        if (!pendingMessage) return;
        
        addUserMessage(pendingMessage.text, pendingMessage.file, pendingMessage.tools);
        
        showTypingIndicator();
        
        const formData = new FormData();
        formData.append("message", pendingMessage.text);
        formData.append("chat_id", chatId);
        formData.append("model", currentModel || "gpt-4");
        formData.append("tools", pendingMessage.tools ? "true" : "false");

        if (pendingMessage.tools) {
            formData.append("tools", "true"); 
        }

        if (pendingMessage.file) {
            formData.append("file", pendingMessage.file);
        }

        try {
            const response = await fetch(BASE_API_URL+"/api/chat/", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            hideTypingIndicator();

            if (data.status === "success") {
                loadChatMessages(chatId);
                loadChatHistory();
            } else {
                addBotMessage("Erreur lors de l'envoi du message.");
                showToast("Erreur API", "error", 3000);
            }
        } catch (error) {
            hideTypingIndicator();
            addBotMessage("Erreur de connexion, veuillez réessayer.");
            showToast("Erreur réseau", "error", 3000);
        } finally {
            pendingMessage = null;
        }
    }

    /**
     * 
     * Fonction pour afficher les historique de chat 
     * 
     * 
     */
    async function loadChatHistory() {
        const container = document.getElementById("chatHistory");

        try {
            const response = await fetch(BASE_API_URL+"/api/chat_list/?getHistory=true");
            if (!response.ok) throw new Error("Erreur API");

            const data = await response.json();

            container.innerHTML = "";

            if (data.status === "success" && data.chat) {
                Object.values(data.chat).forEach(chat => {
                    const div = document.createElement("div");
                    div.className = "px-3 py-2.5 rounded-lg hover:bg-gray-850/60 transition-all cursor-pointer group";

                    const currentUrl = new URL(window.location.href);
                    const baseUrl = currentUrl.origin + currentUrl.pathname;
                    
                    div.addEventListener("click", () => {
                        window.location.href = `${baseUrl}?m=1&id=${chat.id}`;
                    });

                    const title = document.createElement("p");
                    title.className = "text-sm text-gray-300 truncate group-hover:text-gray-100";
                    title.textContent = chat.title;

                    const time = document.createElement("p");
                    time.className = "text-xs text-gray-500 mt-0.5";
                    time.textContent = chat.time_go;

                    div.appendChild(title);
                    div.appendChild(time);
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = "<p class='text-gray-500 text-sm px-3'>Aucun historique trouvé</p>";
            }
        } catch (error) {
            console.error("Erreur lors du chargement de l'historique :", error);
            container.innerHTML = "<p class='text-red-500 text-sm px-3'>Erreur de chargement</p>";
        }
    }

    /**
     * 
     * Une fonction pour afficher les conversations dans l'interface 
     * 
     * 
     */
    async function loadChatMessages(chatId) {
        const chatContainer = document.getElementById("chatContainer");

        try {
            const response = await fetch(BASE_API_URL+`/api/chat_list/?getChatID=${encodeURIComponent(chatId)}`);
            if (!response.ok) throw new Error("Erreur API");

            const data = await response.json();

            // Vider le conteneur de chat
            const chatContent = chatContainer.querySelector('.max-w-4xl');
            if (chatContent) {
                chatContent.innerHTML = '';
            } else {
                chatContainer.innerHTML = '<div class="max-w-4xl mx-auto space-y-6"></div>';
            }

            const newChatContent = chatContainer.querySelector('.max-w-4xl');

            // Si pas de chat → message par défaut
            if (!data.chat || data.chat.length === 0) {
                newChatContent.innerHTML = `
                    <div class="flex items-start space-x-4 first-message-mobile">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="sparkles" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="message-bubble rounded-2xl p-5 max-w-3xl">
                            <div class="prose-custom max-w-none">
                                <p><?=$_TEXT['bot']['default_message'];?></p>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Afficher les messages du chat
            data.chat.forEach(msg => {
                if (msg.role === "user") {
                    addUserMessage(msg.content, null, false);
                } else if (msg.role === "bot") {
                    addBotMessage(msg.content);
                }
            });

            lucide.createIcons();

        } catch (error) {
            console.error("Erreur lors du chargement du chat :", error);
            chatContainer.innerHTML = "<p class='text-red-500 p-4'>Erreur de chargement des messages.</p>";
        }
    }

    /**
     * 
     * Executer le fonction dans la page 
     * 
     */
    document.addEventListener("DOMContentLoaded", () => {
        // Récupérer l'ID du chat depuis les paramètres d'URL
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (chatId) {
            if (pendingMessage) {
                sendPendingMessage(chatId);
            }
            loadChatMessages(chatId);
        }
        
        // Charger l'historique des chats
        loadChatHistory();

        // Gestion des boutons de navigation
        document.querySelector('.new-chat-btn').addEventListener('click', function() {
            startNewChat().then(chatId => {
                if (chatId) {
                    const currentUrl = new URL(window.location.href);
                    const baseUrl = currentUrl.origin + currentUrl.pathname;
                    window.location.href = `${baseUrl}?m=1&id=${chatId}`;
                }
            });
        });

        // Fermer le sidebar sur mobile après clic sur un élément
        document.querySelectorAll('#chatHistory div').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    closeSidebarFunc();
                }
            });
        });
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        if (window.innerWidth < 1024) {
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnMenuButton = menuButton && menuButton.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnMenuButton && sidebar.classList.contains('open')) {
                closeSidebarFunc();
            }
        }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
            closeSidebarFunc();
        }
    });
   </script>